<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dice Roller - Final Edition</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=JetBrains+Mono:wght@400;700&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #1a1520; --surface: #241e2e; --border: #3a2f4a;
    --accent: #c4a35a; --accent-glow: #e8c96880;
    --text: #e8e0f0; --text-dim: #8a7e96; --red: #c45a5a; --green: #5ac47a;
  }
  body {
    font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--text);
    min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 16px;
    background-image: radial-gradient(ellipse at 20% 50%, #2a1f3a 0%, transparent 60%), radial-gradient(ellipse at 80% 50%, #1f2a3a 0%, transparent 60%);
  }
  h1 { font-family: 'Cinzel', serif; font-weight: 800; font-size: 1.3rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 12px; text-shadow: 0 0 20px var(--accent-glow); }
  .roller { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
  .input-row { display: flex; gap: 8px; }
  input[type="text"] { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text); font-family: 'JetBrains Mono', monospace; outline: none; }
  input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
  button.roll-btn { background: linear-gradient(135deg, var(--accent), #a8883a); color: var(--bg); border: none; border-radius: 8px; padding: 10px 20px; font-family: 'Cinzel', serif; font-weight: 800; cursor: pointer; text-transform: uppercase; }
  .quick-btns { display: flex; flex-wrap: wrap; gap: 6px; }
  .quick-btns button { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; color: var(--text-dim); cursor: pointer; font-size: 0.78rem; transition: 0.2s; }
  .quick-btns button:hover { color: var(--accent); border-color: var(--accent); }
  .result-area { margin-top: 15px; min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; }
  .result-total { font-family: 'Cinzel', serif; font-size: 3.2rem; font-weight: 800; color: var(--accent); text-shadow: 0 0 24px var(--accent-glow); line-height: 1; }
  .result-detail { font-size: 0.85rem; color: var(--text-dim); text-align: center; margin-top: 8px; }
  .status { font-size: 0.65rem; margin-top: 15px; padding: 4px 10px; border-radius: 4px; opacity: 0.6; }
  .connected { color: var(--green); border: 1px solid var(--green); }
  .waiting { color: var(--accent); border: 1px solid var(--accent); }
</style>
</head>
<body>

<h1>‚öîÔ∏è Dice Roller</h1>

<div class="roller">
  <div class="input-row">
    <input type="text" id="diceInput" placeholder="2d6+1d4+3..." autocomplete="off">
    <button class="roll-btn" id="rollBtn" onclick="roll()">Roll</button>
  </div>
  <div class="quick-btns">
    <button onclick="quickRoll('1d4')">d4</button>
    <button onclick="quickRoll('1d6')">d6</button>
    <button onclick="quickRoll('1d8')">d8</button>
    <button onclick="quickRoll('1d10')">d10</button>
    <button onclick="quickRoll('1d12')">d12</button>
    <button onclick="quickRoll('1d20')">d20</button>
  </div>
  <div class="result-area" id="resultArea">
    <div class="result-detail">Aguardando rolagem local...</div>
  </div>
</div>

<div id="status" class="status waiting">Offline</div>

<script>
// --- MOTOR DE COMUNICA√á√ÉO (FIX ELEMENT 1.12.10) ---
let widgetId = new URLSearchParams(window.location.search).get('widgetId');
let widgetReady = false;

function sendResponse(originalMsg, data = {}) {
  window.parent.postMessage({
    api: 'toWidget',
    action: originalMsg.action,
    requestid: originalMsg.requestid,
    widgetId: widgetId || originalMsg.widgetId,
    data: originalMsg.data,
    response: data
  }, '*');
}

window.addEventListener('message', (ev) => {
  const msg = ev.data;
  if (!msg || !msg.api) return;

  if (!widgetId || widgetId.startsWith('$')) widgetId = msg.widgetId;

  if (msg.api === 'toWidget') {
    if (msg.action === 'supported_api_versions') {
      sendResponse(msg, { supported_versions: ['0.0.1', '1.1.0'] });
    } else if (msg.action === 'capabilities') {
      sendResponse(msg, { capabilities: ['m.room.message', 'org.matrix.msc2762.send.event:m.room.message'] });
    } else if (msg.action === 'notify_capabilities') {
      widgetReady = true;
      const s = document.getElementById('status');
      s.innerText = "Sincronizado"; s.className = "status connected";
      sendResponse(msg, {});
    } else {
      sendResponse(msg, {}); // Responde a tudo (tema, visibilidade) para manter a conex√£o
    }
  }
});

// For√ßa o carregamento
if (window.parent !== window) {
  window.parent.postMessage({ api: 'fromWidget', action: 'content_loaded', widgetId: widgetId, requestid: 'init-'+Date.now(), data: {} }, '*');
}

// --- SEU PARSER ORIGINAL RESTAURADO ---
function parseDice(str) {
  str = str.replace(/\s+/g, '').toLowerCase();
  let parts = [], regex = /([+-]?)(\d*)d(\d+)|([+-]?\d+)/g, match, hasAnyDice = false;
  while ((match = regex.exec(str)) !== null) {
    if (match[3]) {
      hasAnyDice = true;
      parts.push({ type: 'dice', count: parseInt(match[2] || '1'), faces: parseInt(match[3]), sign: match[1] === '-' ? -1 : 1 });
    } else if (match[4]) {
      parts.push({ type: 'mod', value: parseInt(match[4]) });
    }
  }
  if (!hasAnyDice) throw new Error('Formato inv√°lido');
  return parts;
}

function roll() {
  const notation = document.getElementById('diceInput').value.trim();
  if (!notation) return;
  try {
    const parts = parseDice(notation);
    let total = 0, details = [];
    
    parts.forEach(p => {
      if (p.type === 'dice') {
        let rolls = [];
        for (let i = 0; i < p.count; i++) {
          let r = Math.floor(Math.random() * p.faces) + 1;
          rolls.push(r);
          total += r * p.sign;
        }
        details.push(`${p.sign === -1 ? '-' : ''}${p.count}d${p.faces} [${rolls.join(', ')}]`);
      } else {
        total += p.value;
        details.push(`${p.value >= 0 ? '+' : ''}${p.value}`);
      }
    });

    document.getElementById('resultArea').innerHTML = `
      <div class="result-total">${total}</div>
      <div class="result-detail">${details.join(' ')}</div>
    `;

    if (widgetReady) {
      window.parent.postMessage({
        api: 'fromWidget', action: 'send_event', widgetId: widgetId, requestid: 'r'+Date.now(),
        data: { type: 'm.room.message', content: { msgtype: 'm.notice', body: `üé≤ ${notation} -> [${details.join(' ')}] = ${total}` } }
      }, '*');
    }
  } catch (e) {
    document.getElementById('resultArea').innerHTML = `<div style="color:var(--red)">${e.message}</div>`;
  }
}
function quickRoll(n) { document.getElementById('diceInput').value = n; roll(); }
</script>
</body>
</html>
