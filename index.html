<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öî Dice Roller</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f13; --surface: #1a1a24; --border: #2a2a3a;
    --text: #e0dfe8; --text-dim: #6e6d80;
    --accent: #c8a2ff; --accent-glow: #c8a2ff44;
    --red: #ff6b6b; --green: #6bffa8; --yellow: #ffd96b;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg); color: var(--text);
    min-height: 100vh; padding: 16px; font-size: 13px; overflow-y: auto;
  }
  h1 { font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.02em; }
  .status-bar {
    display: flex; align-items: center; gap: 6px; margin-bottom: 12px;
    font-size: 0.68rem; color: var(--text-dim); padding: 4px 8px;
    background: var(--surface); border-radius: 4px; border: 1px solid var(--border);
  }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--text-dim); transition: background 0.3s; flex-shrink: 0;
  }
  .status-dot.connecting { background: var(--yellow); animation: pulse 1s infinite; }
  .status-dot.connected { background: var(--green); }
  .status-dot.error { background: var(--red); }
  .status-dot.standalone { background: var(--accent); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .roller {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 14px; margin-bottom: 12px;
  }
  .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
  input[type="text"] {
    flex: 1; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; padding: 8px 10px; color: var(--text);
    font-family: inherit; font-size: 0.9rem; outline: none; transition: border-color 0.15s;
  }
  input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  .roll-btn {
    background: var(--accent); color: var(--bg); border: none; border-radius: 6px;
    padding: 8px 18px; font-family: inherit; font-weight: 700; font-size: 0.85rem;
    cursor: pointer; transition: transform 0.1s, box-shadow 0.15s; white-space: nowrap;
  }
  .roll-btn:hover { box-shadow: 0 0 12px var(--accent-glow); }
  .roll-btn:active { transform: scale(0.96); }
  .quick-btns { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px; }
  .quick-btns button {
    background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
    padding: 4px 10px; color: var(--text-dim); font-family: inherit;
    font-size: 0.72rem; cursor: pointer; transition: all 0.15s;
  }
  .quick-btns button:hover { border-color: var(--accent); color: var(--accent); }
  .result-area { text-align: center; padding: 10px 0 4px; min-height: 48px; }
  .result-label { color: var(--text-dim); font-size: 0.82rem; }
  .result-total {
    font-size: 2.2rem; font-weight: 700; color: var(--accent);
    opacity: 0; transform: scale(0.8);
    transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
  }
  .result-total.show { opacity: 1; transform: scale(1); }
  .result-detail { color: var(--text-dim); font-size: 0.75rem; margin-top: 2px; }
  .send-toggle {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);
    font-size: 0.7rem; color: var(--text-dim);
  }
  .send-toggle label { cursor: pointer; display: flex; align-items: center; gap: 6px; }
  .toggle-switch {
    position: relative; width: 32px; height: 18px;
    background: var(--border); border-radius: 9px; cursor: pointer; transition: background 0.2s;
  }
  .toggle-switch::after {
    content: ''; position: absolute; top: 2px; left: 2px;
    width: 14px; height: 14px; background: var(--text-dim);
    border-radius: 50%; transition: all 0.2s;
  }
  .toggle-switch.active { background: var(--accent); }
  .toggle-switch.active::after { left: 16px; background: var(--bg); }
  .toggle-switch.disabled { opacity: 0.4; cursor: not-allowed; }
  .history {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; max-height: 200px; overflow-y: auto;
  }
  .history-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 5px 0; border-bottom: 1px solid var(--border);
    font-size: 0.75rem; animation: slideIn 0.2s ease-out;
  }
  .history-item.no-anim { animation: none; }
  .history-item:last-child { border-bottom: none; }
  .history-item .notation { color: var(--text); font-weight: 700; min-width: 55px; }
  .history-item .dice-vals { color: var(--text-dim); font-size: 0.72rem; }
  .history-item .total { color: var(--accent); font-weight: 700; }
  .history-item .sent-badge { font-size: 0.6rem; color: var(--green); margin-left: 4px; }
  .history-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
  }
  .history-header span {
    font-size: 0.72rem; color: var(--text-dim);
    text-transform: uppercase; letter-spacing: 0.1em;
  }
  .clear-btn {
    background: none; border: 1px solid var(--border); border-radius: 4px;
    padding: 2px 8px; color: var(--text-dim); font-family: inherit;
    font-size: 0.65rem; cursor: pointer; transition: all 0.15s;
  }
  .clear-btn:hover { border-color: var(--red); color: var(--red); }
  .error { color: var(--red); font-size: 0.82rem; text-align: center; }
  .debug-panel {
    margin-top: 12px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
  }
  .debug-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 6px 10px; font-size: 0.65rem; color: var(--text-dim);
    text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; user-select: none;
  }
  .debug-header:hover { color: var(--text); }
  .debug-log {
    display: none; max-height: 150px; overflow-y: auto;
    padding: 6px 10px; border-top: 1px solid var(--border);
    font-size: 0.6rem; line-height: 1.6;
  }
  .debug-log.open { display: block; }
  .debug-line { color: var(--text-dim); word-break: break-all; }
  .debug-line.ok { color: var(--green); }
  .debug-line.warn { color: var(--yellow); }
  .debug-line.err { color: var(--red); }
  .debug-line.info { color: var(--accent); }
  @keyframes slideIn { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
  @keyframes shake {
    0%,100%{transform:scale(1) rotate(0)} 20%{transform:scale(1.1) rotate(-3deg)}
    40%{transform:scale(1.1) rotate(3deg)} 60%{transform:scale(1.1) rotate(-2deg)}
    80%{transform:scale(1.05) rotate(1deg)}
  }
  .rolling { animation: shake 0.4s ease-out; }
</style>
</head>
<body>
<h1>‚öî Dice Roller</h1>
<div class="status-bar"><div class="status-dot" id="statusDot"></div><span id="statusText">Inicializando‚Ä¶</span></div>
<div class="roller">
  <div class="input-row">
    <input type="text" id="diceInput" placeholder="2d6+3, 1d20, 4d8-2‚Ä¶" autocomplete="off" spellcheck="false">
    <button class="roll-btn" id="rollBtn">Roll</button>
  </div>
  <div class="quick-btns">
    <button id="q_d4">d4</button><button id="q_d6">d6</button>
    <button id="q_d8">d8</button><button id="q_d10">d10</button>
    <button id="q_d12">d12</button><button id="q_d20">d20</button>
    <button id="q_d100">d100</button><button id="q_2d6">2d6</button>
  </div>
  <div class="result-area" id="resultArea"><div class="result-label">Rola os dados!</div></div>
  <div class="send-toggle">
    <label><div class="toggle-switch disabled" id="sendToggle"></div>
    <span id="sendToggleText">Enviar na sala (conectando‚Ä¶)</span></label>
  </div>
</div>
<div class="history">
  <div class="history-header"><span>Hist√≥rico</span><button class="clear-btn" id="clearBtn">Limpar</button></div>
  <div id="historyList"></div>
</div>
<div class="debug-panel">
  <div class="debug-header" id="debugToggle">Debug Console <span id="debugArrow">‚ñ∏</span></div>
  <div class="debug-log" id="debugLog"></div>
</div>

<!--
  Matrix Widget API - carregado como ES Module via jsDelivr.
  O script principal do widget √© type="module" para poder usar import.
-->
<script type="module">
  // jsDelivr converte o pacote npm para ES module automaticamente
  import * as MatrixWidgetApi from 'https://cdn.jsdelivr.net/npm/matrix-widget-api@1.9.0/+esm';

  // === Debug Logger ===
  var debugLogEl = document.getElementById('debugLog');
  document.getElementById('debugToggle').addEventListener('click', function() {
    debugLogEl.classList.toggle('open');
    document.getElementById('debugArrow').textContent = debugLogEl.classList.contains('open') ? '‚ñæ' : '‚ñ∏';
  });
  function log(msg, level) {
    var time = new Date().toLocaleTimeString('pt-BR', {hour12:false});
    var line = document.createElement('div');
    line.className = 'debug-line ' + (level||'');
    line.textContent = '['+time+'] '+msg;
    debugLogEl.appendChild(line);
    debugLogEl.scrollTop = debugLogEl.scrollHeight;
    console.log('[DiceRoller] '+msg);
  }

  // === Discover WidgetApi constructor ===
  log('=== Dice Roller v2.1 (ES Module import) ===','info');
  log('MatrixWidgetApi keys: ' + Object.keys(MatrixWidgetApi).join(', '), 'info');

  var WidgetApiClass = null;

  // Try multiple paths to find the WidgetApi constructor
  if (typeof MatrixWidgetApi.WidgetApi === 'function') {
    WidgetApiClass = MatrixWidgetApi.WidgetApi;
    log('WidgetApi encontrada em MatrixWidgetApi.WidgetApi ‚úì', 'ok');
  } else if (MatrixWidgetApi.default && typeof MatrixWidgetApi.default.WidgetApi === 'function') {
    WidgetApiClass = MatrixWidgetApi.default.WidgetApi;
    log('WidgetApi encontrada em MatrixWidgetApi.default.WidgetApi ‚úì', 'ok');
  } else if (typeof MatrixWidgetApi.default === 'function') {
    // Maybe the default export IS the WidgetApi
    WidgetApiClass = MatrixWidgetApi.default;
    log('WidgetApi encontrada em MatrixWidgetApi.default ‚úì', 'ok');
  } else {
    // Log everything we can find to help debug
    log('AVISO: WidgetApi n√£o encontrada nos caminhos esperados', 'warn');
    for (var key in MatrixWidgetApi) {
      if (MatrixWidgetApi.hasOwnProperty(key)) {
        log('  ' + key + ': ' + typeof MatrixWidgetApi[key], 'info');
      }
    }
    // Last resort: check if any export name contains 'Widget'
    for (var key2 in MatrixWidgetApi) {
      if (key2.indexOf('Widget') !== -1 && typeof MatrixWidgetApi[key2] === 'function') {
        WidgetApiClass = MatrixWidgetApi[key2];
        log('WidgetApi candidata: ' + key2, 'warn');
        break;
      }
    }
  }

  // === DOM ===
  var input = document.getElementById('diceInput');
  var resultArea = document.getElementById('resultArea');
  var historyList = document.getElementById('historyList');
  var rollBtn = document.getElementById('rollBtn');
  var statusDot = document.getElementById('statusDot');
  var statusTextEl = document.getElementById('statusText');
  var sendToggleEl = document.getElementById('sendToggle');
  var sendToggleTextEl = document.getElementById('sendToggleText');

  var qb = {q_d4:'1d4',q_d6:'1d6',q_d8:'1d8',q_d10:'1d10',q_d12:'1d12',q_d20:'1d20',q_d100:'1d100',q_2d6:'2d6'};
  Object.keys(qb).forEach(function(id){
    document.getElementById(id).addEventListener('click',function(){input.value=qb[id];doRoll();});
  });
  rollBtn.addEventListener('click', doRoll);
  input.addEventListener('keydown', function(e){if(e.key==='Enter')doRoll();});
  document.getElementById('clearBtn').addEventListener('click', clearHistory);

  // === State ===
  var widgetApi = null, matrixReady = false, sendToRoom = false;
  var HKEY = 'diceRollerHistory', HMAX = 50;

  // === Matrix Widget API Init ===
  function initWidgetApi() {
    var inIframe;
    try { inIframe = window.self !== window.top; } catch(e) { inIframe = true; }
    log('inIframe: '+inIframe, 'info');
    log('location: '+window.location.href, 'info');

    if (!inIframe) {
      log('Modo standalone (fora do Element)', 'warn');
      setStatus('standalone','Modo standalone');
      sendToggleEl.classList.add('disabled');
      sendToggleTextEl.textContent = 'Enviar na sala (indispon√≠vel)';
      return;
    }

    if (!WidgetApiClass) {
      log('ERRO: N√£o foi poss√≠vel encontrar o construtor WidgetApi', 'err');
      setStatus('error','Erro: WidgetApi n√£o encontrada');
      return;
    }

    // widgetId from URL
    var params = new URLSearchParams(window.location.search);
    var wid = params.get('widgetId');
    if (wid && wid.indexOf('$') === 0) { log('widgetId template n√£o resolvido: "'+wid+'"','warn'); wid = null; }
    log('widgetId: '+(wid||'(auto-detect)'), 'info');
    setStatus('connecting','Conectando ao Element‚Ä¶');

    try {
      widgetApi = new WidgetApiClass(wid);
      log('WidgetApi instanciada ‚úì', 'ok');

      // MSC2762: request send capability
      widgetApi.requestCapability('org.matrix.msc2762.send.event:m.room.message');
      log('Capability solicitada: send m.room.message', 'info');

      // Ready = handshake complete
      widgetApi.on('ready', function() {
        log('=== READY! Handshake completo! ===', 'ok');
        matrixReady = true;
        setStatus('connected','Conectado ao Element ‚úì');
        sendToggleEl.classList.remove('disabled');
        sendToggleEl.classList.add('active');
        sendToRoom = true;
        sendToggleTextEl.textContent = 'Enviar na sala';
      });

      // Start handshake
      widgetApi.start();
      log('start() chamado ‚Äî handshake iniciado', 'info');

      // Content loaded signal
      widgetApi.sendContentLoaded();
      log('content_loaded enviado ‚úì', 'ok');

      // Timeout
      setTimeout(function(){
        if (!matrixReady) {
          log('‚è± Timeout 15s ‚Äî Element n√£o respondeu','warn');
          setStatus('error','Timeout ‚Äî sem resposta');
          sendToggleTextEl.textContent = 'Enviar na sala (sem conex√£o)';
        }
      }, 15000);

    } catch(err) {
      log('ERRO ao instanciar: '+err.message, 'err');
      log('Stack: '+(err.stack||'N/A').substring(0,200), 'err');
      setStatus('error','Erro: '+err.message);
    }
  }

  // === Toggle ===
  sendToggleEl.addEventListener('click', function(){
    if (sendToggleEl.classList.contains('disabled')) return;
    sendToRoom = !sendToRoom;
    sendToggleEl.classList.toggle('active', sendToRoom);
    log('Enviar na sala: '+(sendToRoom?'ON':'OFF'),'info');
  });

  function setStatus(state, text) {
    statusDot.className = 'status-dot '+state;
    statusTextEl.textContent = text;
  }

  // === Send to Matrix ===
  function sendToMatrix(notation, detail, total) {
    if (!matrixReady || !widgetApi || !sendToRoom) return;
    var body = 'üé≤ '+notation+': '+detail+' = '+total;
    var html = '<strong>üé≤ '+notation+'</strong>: <code>'+detail+'</code> = <strong>'+total+'</strong>';
    log('Enviando: '+body, 'info');
    try {
      widgetApi.sendRoomEvent('m.room.message', {
        msgtype: 'm.text', body: body,
        format: 'org.matrix.custom.html', formatted_body: html
      }).then(function(r){
        log('‚úì Evento enviado! '+(r&&r.event_id?r.event_id:'ok'),'ok');
      }).catch(function(e){
        log('‚úó Erro ao enviar: '+(e&&e.message?e.message:String(e)),'err');
      });
    } catch(e){ log('Erro s√≠ncrono: '+e.message,'err'); }
  }

  // === History ===
  function loadH(){try{var d=localStorage.getItem(HKEY);return d?JSON.parse(d):[];}catch(e){return[];}}
  function saveH(e){try{localStorage.setItem(HKEY,JSON.stringify(e.slice(0,HMAX)));}catch(e){}}
  function clearHistory(){try{localStorage.removeItem(HKEY);}catch(e){}historyList.innerHTML='';resultArea.innerHTML='<div class="result-label">Rola os dados!</div>';}

  function renderSavedHistory(){
    var entries=loadH(); if(!entries.length)return;
    var l=entries[0];
    resultArea.innerHTML='<div class="result-total show">'+l.total+'</div><div class="result-detail">'+l.detail+'</div>';
    entries.forEach(function(e){
      var it=document.createElement('div'); it.className='history-item no-anim';
      it.innerHTML='<span class="notation">'+e.notation+'</span><span class="dice-vals">'+e.detail+'</span><span class="total">'+e.total+(e.sent?'<span class="sent-badge">‚úì</span>':'')+'</span>';
      historyList.appendChild(it);
    });
  }

  function addHistory(notation,detail,total,sent){
    var it=document.createElement('div'); it.className='history-item';
    it.innerHTML='<span class="notation">'+notation+'</span><span class="dice-vals">'+detail+'</span><span class="total">'+total+(sent?'<span class="sent-badge">‚úì</span>':'')+'</span>';
    historyList.insertBefore(it,historyList.firstChild);
    var e=loadH(); e.unshift({notation:notation,detail:detail,total:total,sent:sent}); saveH(e);
  }

  // === Dice Logic ===
  function parseDice(str){
    str=str.replace(/\s+/g,'').toLowerCase();
    var parts=[],regex=/([+-]?)(\d*)d(\d+)|([+-]?\d+)/g,m,any=false;
    while((m=regex.exec(str))!==null){
      if(m[3]){any=true;var s=m[1]==='-'?-1:1,c=parseInt(m[2]||'1'),f=parseInt(m[3]);
        if(c<1||c>100)throw new Error('Dados: 1-100');if(f<2||f>1000)throw new Error('Faces: 2-1000');
        parts.push({type:'dice',count:c,faces:f,sign:s});
      }else if(m[4])parts.push({type:'mod',value:parseInt(m[4])});
    }
    if(!any)throw new Error('Use: 2d6, 1d20+5‚Ä¶');return parts;
  }

  function rollDice(parts){
    var total=0,rolls=[];
    for(var i=0;i<parts.length;i++){var p=parts[i];
      if(p.type==='dice'){var dr=[];
        for(var j=0;j<p.count;j++)dr.push(Math.floor(Math.random()*p.faces)+1);
        total+=dr.reduce(function(a,b){return a+b;},0)*p.sign;
        rolls.push({label:(p.sign===-1?'-':'')+p.count+'d'+p.faces,values:dr,sign:p.sign});
      }else{total+=p.value;rolls.push({label:(p.value>=0?'+':'')+p.value,values:[],sign:1});}
    }
    return {total:total,rolls:rolls};
  }

  function fmtRolls(rolls){
    return rolls.map(function(r){return r.values.length?r.label+' ['+r.values.join(', ')+']':r.label;}).join(' ');
  }

  // === Main Roll ===
  function doRoll(){
    var notation=input.value.trim(); if(!notation){input.focus();return;}
    try{
      var parts=parseDice(notation),result=rollDice(parts),detail=fmtRolls(result.rolls);
      rollBtn.classList.remove('rolling');void rollBtn.offsetWidth;rollBtn.classList.add('rolling');
      resultArea.innerHTML='<div class="result-total">'+result.total+'</div><div class="result-detail">'+detail+'</div>';
      var te=resultArea.querySelector('.result-total');void te.offsetWidth;te.classList.add('show');
      var sent=false;
      if(matrixReady&&sendToRoom){sendToMatrix(notation,detail,result.total);sent=true;}
      addHistory(notation,detail,result.total,sent);
      log('Roll: '+notation+' ‚Üí '+detail+' = '+result.total+(sent?' [enviado]':''),'ok');
    }catch(err){resultArea.innerHTML='<div class="error">'+err.message+'</div>';log('Erro: '+err.message,'err');}
  }

  // === Init ===
  renderSavedHistory(); initWidgetApi(); input.focus();
</script>
</body>
</html>
